image: alpine:latest

before_script:
  - apk add --quiet openssh-client
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  - mkdir -p ~/.ssh && touch ~/.ssh/known_hosts
  - chmod 700 ~/.ssh
  - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts

deploy_dev:
  script:
    # Deploy
    - ssh -o StrictHostKeyChecking=no knowledge@knowledge.msharks.ru "cd ~/knowledge.msharks.ru/code/ && git pull && git checkout dev && docker-compose stop php-http && docker-compose up -d php-http && docker-compose restart web && docker exec -i kb_php_http composer install && docker exec -i kb_php_http php artisan migrate"
  only:
    - dev

deploy_release:
  script:
    # Deploy release branch
    - ssh -o StrictHostKeyChecking=no kb_admin@knowledge.oktadi.ru "cd /var/www/knowledge/backend/ && git fetch --all && git reset --hard origin/release && composer install && php artisan migrate"
  only:
    - release

deploy_master:
  script:
    # Deploy master branch
    - ssh -o StrictHostKeyChecking=no knowledge@doxcase-demo.oktadi.ru "cd ~/doxcase-demo.oktadi.ru/data/php-fpm && git fetch --all && git reset --hard origin/master && docker-compose stop php-fpm && docker-compose up -d php-fpm && docker-compose restart nginx && docker exec -i php-fpm composer install && docker exec -i php-fpm php artisan migrate"
  only:
    - master
